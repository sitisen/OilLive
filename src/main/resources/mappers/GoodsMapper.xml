<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oillive.dao.GoodsDao">

	<!-- 장바구니 조회 시, 사용하는 ResultMap -->
	<resultMap type="BasketVO" id="basketMap">
	    <result column="USER_CODE" property="userCode"/>
	    <result column="BASKET_CODE" property="basketCode"/>
	    <result column="BASKET_AMOUNT" property="basketAmount"/>
	   	<collection property="goodsVO" resultMap="goodsVO"/>
	</resultMap>
	<resultMap type="GoodsVO" id="goodsVO">
	    <result column="GOODS_CODE" property="goodsCode"/>
	    <result column="GOODS_NAME" property="goodsName"/>
	    <result column="GOODS_PRICE" property="goodsPrice"/>
	    <result column="GOODS_DISCOUNT" property="goodsDiscount"/>
	   	<result column="GOODS_AMOUNT" property="goodsAmount"/>
	</resultMap>
	
	
	<!-- 특정 상품 조회 -->
	<select id="selectGoods" parameterType="String" resultType="GoodsVO">
		SELECT goods_code, goods_name, goods_kind, goods_price, 
		       goods_amount, goods_content, goods_discount, goods_date
		  FROM goods
		 WHERE goods_code = #{goodsCode}
	</select>
	
	<!-- 특정 장바구니 조회 -->
	<select id="selectBasket" parameterType="Map" resultMap="basketMap">
		SELECT user_code, basket_code, basket_amount, 
		       goods_code, goods_name, goods_price, goods_discount, goods_amount
		  FROM basket
		  JOIN goods
		 USING (goods_code)
		 WHERE user_code = #{userCode}
		   AND basket_code IN
		<foreach collection="basketCode" item="code" open="(" close=")" separator=",">
			#{code}
		</foreach>
	</select>
	
	<!-- 상품 종류 탭 조회 -->
	<select id="selectGoodsKind" resultType="String">
		SELECT DISTINCT goods_kind
				   FROM goods
			   ORDER BY goods_kind ASC
	</select>
	
	<!-- 상품 목록 개수 조회 (페이징) -->
	<select id="selectGoodsCount" parameterType="Map" resultType="int">
		   SELECT count(*)
			 FROM goods
			WHERE 1 = 1
		<if test="! goodsName.isEmpty()">
			  AND goods_name LIKE '%' || #{goodsName} || '%'
		</if>
		<if test='! selectedKind.equals("전체")'>
			  AND goods_kind = #{selectedKind}
		</if>
	</select>
	
	<!-- 상품 목록 조회 -->
	<select id="selectGoodsList" parameterType="Map" resultType="Map">
		SELECT G.*
		  FROM (  SELECT ROWNUM RNUM, goods_code, goods_name, goods_kind, goods_price, 
		                 goods_amount, goods_content, goods_discount, goods_date
        		    FROM goods
        		    WHERE 1 = 1
		<if test="! goodsName.isEmpty()">
					  AND goods_name LIKE '%' || #{goodsName} || '%'
		</if>
		<if test='! selectedKind.equals("전체")'>
					  AND goods_kind = #{selectedKind}
		</if>
				ORDER BY RNUM ASC
      		    ) G
		 WHERE G.rnum BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 상품 수량 갱신 -->
	<update id="updateGoodsAmount" parameterType="Map">
		UPDATE goods
		   SET goods_amount = goods_amount - #{orderAmount}
		 WHERE goods_code = #{goodsCode}
	</update>
	
</mapper>